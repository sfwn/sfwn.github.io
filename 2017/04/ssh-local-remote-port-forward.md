# ssh 远程/本地 端口转发

> Date: 2017-04-05
>
> Author: sfwn

## 一. ssh 远程端口转发
#### 1. 场景 
> 你的本机可以访问公网，但是没有公网 IP。现在本机运行着一个 java 程序，通过这个 java 程序会在一台阿里云的服务器上执行一段脚本，脚本执行完毕后需要将执行结果通过公网回调至本机的 java 程序。   

- 当本机拥有公网 IP 时，直接通过 `ip + port` 或者 nginx 转发即可完成回调；
- 但更常见的情况是，你处在局域网内，对外只有一个公网 IP（`curl ip.cn` 可以拿到这个对外的 IP）。回调时，无法通过这个 IP 找到本机。

这时候 **ssh 远程端口转发** 就登场了。为什么称为 **远程** 端口转发而不是 **本地** 端口转发呢？原因就在于你通过本机建立的这条 ssh 连接是给远程服务器使用的。是不是有很多疑惑？别急，看完下面的例子你就明白了。

#### 2. 举例
假设本机可以 ssh 到阿里云的服务器（1.2.3.4）上，反之不行。

##### 目标：
```
能够在阿里云机器上通过访问该云主机的某一个端口（比如 23333），就能访问到你本机的 java 应用（8080）。
```
可以使用下面的命令：
```
$ ssh -R 23333:127.0.0.1:8080 root@1.2.3.4
```
上面的命令建立了一条 **本机到远程服务器** 的 ssh 连接，然后将远程服务器的某个端口（*23333*）映射到本机的一个端口（*8080*）。当远程服务器访问自己的 *23333* 端口时，相当于访问你本机 java 程序的 *8080* 端口。如果在本机再用
```
$ ssh -R 23334:127.0.0.1:8080 root@1.2.3.4
```
建立另一条 ssh 连接，那么远程服务器可以通过 *23333* 和 *23334* 端口来访问本机的 *8080* 端口。而本机的 8080 端口不受影响。


## 二. ssh 本地端口转发
#### 1. 场景
和远程端口转发对应，ssh 本地端口转发的意思就是：
```
通过访问本机的一个端口来访问远程服务器上的一个端口，而远程服务器上的端口不受影响。
```
比如你想通过本机的 *8086* 端口访问到远程服务器的 *8086* 端口：
```
$ ssh -L 8086:127.0.0.1:8086 root@1.2.3.4
```
这样，当你访问本机的 *8086* 端口时，实际上访问的是远程服务器的 *8086* 端口。
> 注意，本机的 *8086* 端口需要未被占用。

#### 2. 举例
远程服务器 1.2.3.4 上的 *6379* 端口运行着 **测试环境** 的 Redis，但是由于安全组或者是防火墙的设置，外网只能访问 *80* 端口和 *22* 端口，*6379* 是不对外暴露的。本地调试时，想要连接这个 Redis 应该怎么做呢？很简单，通过 ssh 本地隧道转发可以将本机的 6380 端口映射到远程服务器 1.2.3.4 的 *6379* 端口上：
```
$ ssh -L 6380:127.0.0.1:6379 root@1.2.3.4
```
这样，程序里面就可以使用 `127.0.0.1:6380` 连接远程服务器上的 Redis，同时可以使用 `127.0.0.1:6379` 访问本机的 Redis。